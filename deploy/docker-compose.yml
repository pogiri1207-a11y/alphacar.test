version: '3.8'

networks:
  backnet:
    driver: bridge

services:
  # [Traefik]
  traefik:
    image: traefik:3.6
    container_name: traefik
    restart: always
    environment:
      - DOCKER_API_VERSION=${DOCKER_API_VERSION}
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:9090"
      - "--api.insecure=true"
      - "--log.level=DEBUG"
      - "--accesslog=true"
    ports:
      - "9090:9090"
      - "${TRAEFIK_DASHBOARD_PORT}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backnet

  # [Nginx]
  nginx:
    image: 192.168.0.169/alphacar-project/alphacar-nginx:${FRONTEND_VERSION:-1.0.0}
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8000:8000"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - traefik
    networks:
      - backnet

  # [Frontend]
  frontend:
    image: 192.168.0.169/alphacar-project/alphacar-frontend:${FRONTEND_VERSION:-1.0.0}
    container_name: frontend
    restart: always
    environment:
      - API_URL=https://${NIP_DOMAIN}/api
      - PORT=8000
      - NEXT_PUBLIC_BASE_URL=https://${NIP_DOMAIN}
      - NEXT_PUBLIC_DOMAIN=https://${NIP_DOMAIN}
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/selfsigned.crt
    expose:
      - "8000"
    volumes:
      - /etc/nginx/ssl/selfsigned.crt:/etc/ssl/certs/selfsigned.crt:ro
    networks:
      - backnet

  # [Main Backend]
  main-backend:
    image: 192.168.0.169/alphacar-project/alphacar-main:${BACKEND_VERSION:-1.0.0}
    container_name: main_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3002
      - SERVICE_NAME=main-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_LOG_LEVEL=debug
      - OTEL_DIAG_LEVEL=debug
      # MongoDB
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER}
      - DATABASE_PASSWORD=${MONGO_PASS}
      - DATABASE_NAME=${MONGO_DB_NAME}
      # Redis
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.main.loadbalancer.server.port=3002"
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.routers.main.entrypoints=web"
      - "traefik.http.routers.main.rule=PathPrefix(`/api/main`) || PathPrefix(`/api/history`) || PathPrefix(`/api/recent-views`) || PathPrefix(`/api/sales`) || PathPrefix(`/api/brands`) || PathPrefix(`/api/favorites`) || PathPrefix(`/api/log-view`) || PathPrefix(`/api/makers`) || PathPrefix(`/api/models`) || PathPrefix(`/api/trims`) || PathPrefix(`/api/cars`) || PathPrefix(`/api/review-analysis`)"
      - "traefik.http.routers.main.middlewares=strip-api"
      - "traefik.http.routers.main-detail.rule=PathPrefix(`/api/vehicles/detail`)"
      - "traefik.http.routers.main-detail.entrypoints=web"
      - "traefik.http.routers.main-detail.priority=100"
      - "traefik.http.routers.main-detail.middlewares=strip-api"

  # [Quote Backend]
  quote-backend:
    #image: 192.168.0.169/alphacar-project/alphacar-quote:${BACKEND_VERSION:-1.0.0}
    image: 192.168.0.169/alphacar-project/alphacar-quote:${BACKEND_VERSION:-1.0.0}
    #    ports:
    #      - "3003:3003"
    #    container_name: quote_backend
    deploy:
      mode: replicated
      replicas: 3
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3003
      - SERVICE_NAME=quote-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # MongoDB
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER}
      - DATABASE_PASSWORD=${MONGO_PASS}
      - DATABASE_NAME=${MONGO_DB_NAME}
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.quote.loadbalancer.server.port=3003"
      - "traefik.http.middlewares.strip-api-quote.stripprefix.prefixes=/api"
      - "traefik.http.routers.quote.rule=PathPrefix(`/api/vehicles`) || PathPrefix(`/api/estimate`) || PathPrefix(`/api/quote`)"
      - "traefik.http.routers.quote.entrypoints=web"
      - "traefik.http.routers.quote.priority=50"

  # [Search Backend]
  search-backend:
    image: 192.168.0.169/alphacar-project/alphacar-search:${BACKEND_VERSION:-1.0.0} 
    container_name: search_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3007
      - SERVICE_NAME=search-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # MongoDB
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER}
      - DATABASE_PASSWORD=${MONGO_PASS}
      - DATABASE_NAME=${MONGO_DB_NAME}
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.search.loadbalancer.server.port=3007"
      - "traefik.http.middlewares.strip-api-search.stripprefix.prefixes=/api"
      - "traefik.http.routers.search.rule=PathPrefix(`/api/search`)"
      - "traefik.http.routers.search.entrypoints=web"
      - "traefik.http.routers.search.middlewares=strip-api-search"

  # [MyPage Backend]
  mypage-backend:
    image: 192.168.0.169/alphacar-project/alphacar-mypage:${BACKEND_VERSION:-1.0.0}
    container_name: mypage_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3006
      - SERVICE_NAME=mypage-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # MongoDB
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER}
      - DATABASE_PASSWORD=${MONGO_PASS}
      - DATABASE_NAME=${MONGO_DB_NAME}
      # MariaDB
      - MARIADB_HOST=${MARIADB_HOST}
      - MARIADB_PORT=${MARIADB_PORT}
      - MARIADB_USERNAME=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASS}
      - MARIADB_DATABASE=${MARIADB_DB_NAME}
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.mypage.loadbalancer.server.port=3006"
      - "traefik.http.middlewares.strip-api-mypage.stripprefix.prefixes=/api"
      - "traefik.http.routers.mypage.rule=PathPrefix(`/api/mypage`) || PathPrefix(`/auth`)"
      - "traefik.http.routers.mypage.entrypoints=web"
      - "traefik.http.routers.mypage.middlewares=strip-api-mypage"

  # [Community Backend]
  community-backend:
    image: 192.168.0.169/alphacar-project/alphacar-community:${BACKEND_VERSION:-1.0.0}
    container_name: community_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3005
      - SERVICE_NAME=community-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # MariaDB
      - MARIADB_TYPE=mariadb
      - MARIADB_HOST=${MARIADB_HOST}
      - MARIADB_PORT=${MARIADB_PORT}
      - MARIADB_USERNAME=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASS}
      - MARIADB_DATABASE=${MARIADB_DB_NAME}
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.community.loadbalancer.server.port=3005"
      - "traefik.http.middlewares.strip-api-comm.stripprefix.prefixes=/api"
      - "traefik.http.routers.community.rule=PathPrefix(`/api/community`)"
      - "traefik.http.routers.community.entrypoints=web"
      - "traefik.http.routers.community.middlewares=strip-api-comm"

  # [AI Chat Backend]
  aichat-backend:
    image: 192.168.0.169/alphacar-project/alphacar-aichat:${BACKEND_VERSION:-1.0.0}
    container_name: aichat_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=4000
      - SERVICE_NAME=aichat-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_LOG_LEVEL=debug
      - OTEL_DIAG_LEVEL=debug
      # MongoDB (계정 다름 주의!)
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER_AICHAT}
      - DATABASE_PASSWORD=${MONGO_PASS_AICHAT}
      - DATABASE_NAME=${MONGO_DB_NAME}
      # AWS Bedrock
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEDROCK_GUARDRAIL_ID=${BEDROCK_GUARDRAIL_ID}
      - BEDROCK_GUARDRAIL_VERSION=${BEDROCK_GUARDRAIL_VERSION}
      - BEDROCK_EMBEDDING_MODEL_ID=${BEDROCK_EMBEDDING_MODEL_ID}
      - BEDROCK_MODEL_ID=${BEDROCK_EMBEDDING_MODEL_ID}  
      - BEDROCK_LLM_MODEL_ID=${BEDROCK_LLM_MODEL_ID}
    volumes:
      - ../backend/aichat/vector_store:/app/vector_store
      - ../backend/aichat/dist:/app/dist
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.aichat.loadbalancer.server.port=4000"
      - "traefik.http.middlewares.ai-rewrite.replacepathregex.regex=^/api/chat/(.*)"
      - "traefik.http.middlewares.ai-rewrite.replacepathregex.replacement=/chat/$$1"
      - "traefik.http.routers.aichat.rule=PathPrefix(`/api/chat`)"
      - "traefik.http.routers.aichat.entrypoints=web"
      - "traefik.http.routers.aichat.middlewares=ai-rewrite"

  # [Drive Backend]
  drive-backend:
    image: 192.168.0.169/alphacar-project/alphacar-drive:${BACKEND_VERSION:-1.0.0}
    container_name: drive_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3008
      - SERVICE_NAME=drive-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # MongoDB
      - DATABASE_HOST=${MONGO_HOST}
      - DATABASE_PORT=${MONGO_PORT}
      - DATABASE_USER=${MONGO_USER}
      - DATABASE_PASSWORD=${MONGO_PASS}
      - DATABASE_NAME=${MONGO_DB_NAME}
    extra_hosts:
      - "mongodb_primary:${MONGO_HOST}"
      - "mongodb_secondary_1:${MONGO_HOST}"
      - "mongodb_secondary_2:${MONGO_HOST}"
      # 하이픈(-) 버전도 안전하게 포함
      - "mongodb-primary:${MONGO_HOST}"
      - "mongodb-secondary-1:${MONGO_HOST}"
      - "mongodb-secondary-2:${MONGO_HOST}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.drive.loadbalancer.server.port=3008"
      - "traefik.http.middlewares.strip-api-drive.stripprefix.prefixes=/api"
      - "traefik.http.routers.drive.rule=PathPrefix(`/api/drive`)"
      - "traefik.http.routers.drive.entrypoints=web"
      - "traefik.http.routers.drive.middlewares=strip-api-drive"
