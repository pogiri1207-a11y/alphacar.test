# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

# ëª¨ë“  íŒŒì¼ ë³µì‚¬
COPY . .

# ê¸€ë¡œë²Œ íˆ´ ì„¤ì¹˜
RUN npm install -g @nestjs/cli @types/node

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •] schemas í´ë”ê°€ ìˆë‹¤ë©´, ì•±ì˜ src í´ë” ì•ˆìœ¼ë¡œ ë³µì‚¬í•´ë¼! ğŸ‘‡ğŸ‘‡ğŸ‘‡
# (main ì„œë¹„ìŠ¤ê°€ schemasë¥¼ ì°¾ì„ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë§ˆë²•ì˜ ì£¼ë¬¸ì…ë‹ˆë‹¤)
RUN [ -d "schemas" ] && cp -r schemas ${APP_NAME}/src/ || true

# --- MSA ë¹Œë“œ ì‹¤í–‰ ---
RUN cd ${APP_NAME} && \
    npm install && \
    nest build

# 2. ì‹¤í–‰ ë‹¨ê³„ (ìµœì¢… ì´ë¯¸ì§€)
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app

# ëŸ°íƒ€ì„ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/${APP_NAME}/dist ./dist
COPY --from=builder /app/${APP_NAME}/package.json ./

# í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm install --production

EXPOSE 3000-4000
CMD ["node", "dist/main"]
