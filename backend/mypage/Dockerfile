# ---------------------------------------------------
# 1. ë¹Œë“œ ë‹¨ê³„ (Builder) - ëª¨ë“  ë„êµ¬ í¬í•¨
# ---------------------------------------------------
FROM node:20-alpine AS builder
ARG APP_NAME=mypage

WORKDIR /app

# 1-1. ì•ŒíŒŒì¸ ë¦¬ëˆ…ìŠ¤ í•„ìˆ˜ íŒ¨í‚¤ì§€ (NestJS/Node í˜¸í™˜ì„±)
RUN apk add --no-cache libc6-compat

# 1-2. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
COPY package.json package-lock.json ./
COPY ${APP_NAME}/package.json ${APP_NAME}/ || true

# 1-3. ì˜ì¡´ì„± ì„¤ì¹˜ (CI ëª¨ë“œ: ë¹ ë¥´ê³  ì •í™•í•¨)
RUN npm install -g @nestjs/cli
RUN npm install --legacy-peer-deps

# 1-4. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° ë¹Œë“œ
# ì„œë¹„ìŠ¤ë³„ package.jsonì´ ìˆìœ¼ë©´ ë³µì‚¬ (ì—†ì–´ë„ ë¹Œë“œ ê³„ì†)
RUN if [ -f ${APP_NAME}/package.json ]; then \
        mkdir -p ${APP_NAME} && \
        cp ${APP_NAME}/package.json ${APP_NAME}/; \
    fi || true
COPY . .
# ìŠ¤í‚¤ë§ˆ ë³µì‚¬ (í•„ìš”í•œ ê²½ìš°)
RUN [ -d "schemas" ] && cp -r schemas ${APP_NAME}/src/ || true

# 1-5. OpenTelemetry íƒ€ì… ì—ëŸ¬ ê°•ì œ ë¬´ì‹œ ì²˜ë¦¬
RUN if [ -f instrumentation.ts ]; then \
        sed -i '/traceExporter:/i \        // @ts-ignore' instrumentation.ts; \
    fi
RUN if [ -f ${APP_NAME}/instrumentation.ts ]; then \
        sed -i '/traceExporter:/i \        // @ts-ignore' ${APP_NAME}/instrumentation.ts; \
    fi

# 1-6. ë¹Œë“œ ì‹¤í–‰ (ë©”ëª¨ë¦¬ ì œí•œ, íƒ€ì„ì•„ì›ƒ, ìƒì„¸ ë¡œê·¸)
RUN echo "ğŸš€ Starting nest build for ${APP_NAME}..." && \
    cd ${APP_NAME} && \
    NODE_OPTIONS="--max-old-space-size=4096" nest build --verbose 2>&1 | tee /tmp/build.log && \
    echo "âœ… Build completed successfully" && \
    ls -la dist/ || (echo "âŒ Build failed, showing logs:" && cat /tmp/build.log && exit 1)

# 1-7. [ë‹¤ì´ì–´íŠ¸ í•µì‹¬] ë¹Œë“œ ì™„ë£Œ í›„, ì‹¤í–‰ì— í•„ìš” ì—†ëŠ” 'ê°œë°œìš© íŒ¨í‚¤ì§€' ì œê±°
RUN npm prune --production
RUN cd ${APP_NAME} && npm prune --production || true

# ---------------------------------------------------
# 2. ì‹¤í–‰ ë‹¨ê³„ (Runner) - ì´ˆê²½ëŸ‰í™”
# ---------------------------------------------------
FROM node:20-alpine AS runner
ARG APP_NAME=mypage

WORKDIR /app
ENV NODE_ENV=production

# 2-1. ì •ë¦¬ëœ node_modules ë³µì‚¬
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/${APP_NAME}/node_modules ./${APP_NAME}/node_modules || true

# 2-2. ì‹¤í–‰ íŒŒì¼(dist)ê³¼ ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/${APP_NAME}/dist ./dist
COPY --from=builder /app/${APP_NAME}/package.json ./package.json

# 2-3. ì‹¤í–‰ ëª…ë ¹ì–´ (nest build ê²°ê³¼ë¬¼ ê²½ë¡œ)
CMD ["node", "dist/main"]
