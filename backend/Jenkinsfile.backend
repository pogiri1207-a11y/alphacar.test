pipeline {
    agent any

    parameters {
        // ÎπåÎìúÌï† ÏÑúÎπÑÏä§Î•º ÏÑ†ÌÉù (Ï†ÑÏ≤¥ ÎπåÎìúÎèÑ Í∞ÄÎä•ÌïòÍ≤å 'all' Ï∂îÍ∞Ä)
        choice(name: 'SERVICE_NAME', 
               choices: ['all', 'main', 'aichat', 'news', 'mypage', 'community', 'search', 'quote'], 
               description: 'ÎπåÎìúÌï† Î∞±ÏóîÎìú ÏÑúÎπÑÏä§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî')
        string(name: 'VERSION', defaultValue: '1.0', description: 'Í∏∞Î≥∏ Î≤ÑÏ†Ñ (Îí§Ïóê ÎπåÎìú Î≤àÌò∏Í∞Ä ÏûêÎèôÏúºÎ°ú Î∂ôÏäµÎãàÎã§)')
    }

    environment {
        HARBOR_URL = 'http://192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        CREDENTIAL_ID = 'harbor-cred' // Ï††ÌÇ®Ïä§Ïóê Îì±Î°ùÌïú Harbor ID/PW
        SONARQUBE = 'sonarqube'
        SONAR_URL = 'http://192.168.56.200:32001'
        SONAR_TOKEN_ID = 'sonarqube-token' // SonarQube ÌÜ†ÌÅ∞ (ÏóÜÏúºÎ©¥ Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ï)
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    // Î≤ÑÏ†Ñ Î≤àÌò∏ ÏÉùÏÑ± (Ïòà: 1.0.25)
                    env.FULL_VERSION = "${params.VERSION}.${currentBuild.number}"
                    
                    // ÎπåÎìúÌï† ÏÑúÎπÑÏä§ Î™©Î°ù Í≤∞Ï†ï
                    if (params.SERVICE_NAME == 'all') {
                        env.SERVICES = 'main,aichat,news,mypage,community,search,quote'
                    } else {
                        env.SERVICES = params.SERVICE_NAME
                    }
                    echo "üöÄ Target Services: ${env.SERVICES} / Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    // SonarQube Ïó∞Í≤∞ ÌôïÏù∏ Î∞è ÏÑ†ÌÉùÏ†Å Ïã§Ìñâ
                    def sonarAvailable = false
                    try {
                        def response = sh(
                            script: "curl -s -m 5 ${SONAR_URL}/api/system/status || echo 'FAILED'",
                            returnStdout: true
                        ).trim()
                        if (response.contains('"status"') || response.contains('UP')) {
                            sonarAvailable = true
                            echo "‚úÖ SonarQube ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌôïÏù∏Îê®"
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è SonarQube ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®: ${e.getMessage()}"
                    }
                    
                    if (sonarAvailable) {
                        def scannerHome = tool 'sonar-scanner'
                        
                        // SonarQube Ïù∏Ï¶ù ÌÜ†ÌÅ∞ ÏÇ¨Ïö© (Ïò§Î•ò Î¨¥ÏãúÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ)
                        try {
                            withSonarQubeEnv("${SONARQUBE}") {
                                def output = sh(
                                    script: """
                                        ${scannerHome}/bin/sonar-scanner \\
                                            -Dsonar.projectKey=alphacar-backend \\
                                            -Dsonar.projectName=alphacar-backend \\
                                            -Dsonar.sources=backend \\
                                            -Dsonar.host.url=${SONAR_URL} \\
                                            -Dsonar.sourceEncoding=UTF-8 \\
                                            -Dsonar.scanner.timeout=300 2>&1
                                    """,
                                    returnStdout: true
                                )
                                if (output.contains("ANALYSIS SUCCESSFUL")) {
                                    echo "‚úÖ SonarQube Î∂ÑÏÑù ÏôÑÎ£å"
                                } else {
                                    echo "‚ö†Ô∏è SonarQube Î∂ÑÏÑù ÏôÑÎ£å (ÏùºÎ∂Ä Í≤ΩÍ≥† Î∞úÏÉù, Í≥ÑÏÜç ÏßÑÌñâ)"
                                }
                            }
                        } catch (Exception e) {
                            // withSonarQubeEnv Ïã§Ìå® Ïãú ÌÜ†ÌÅ∞ ÏßÅÏ†ë ÏÇ¨Ïö© ÏãúÎèÑ
                            echo "‚ö†Ô∏è withSonarQubeEnv Ïã§Ìå®, ÌÜ†ÌÅ∞ ÏßÅÏ†ë ÏÇ¨Ïö© ÏãúÎèÑ..."
                            try {
                                withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'SONAR_TOKEN')]) {
                                    def output = sh(
                                        script: """
                                            ${scannerHome}/bin/sonar-scanner \\
                                                -Dsonar.projectKey=alphacar-backend \\
                                                -Dsonar.projectName=alphacar-backend \\
                                                -Dsonar.sources=backend \\
                                                -Dsonar.host.url=${SONAR_URL} \\
                                                -Dsonar.token=\${SONAR_TOKEN} \\
                                                -Dsonar.sourceEncoding=UTF-8 \\
                                                -Dsonar.scanner.timeout=300 2>&1
                                        """,
                                        returnStdout: true
                                    )
                                    if (output.contains("ANALYSIS SUCCESSFUL")) {
                                        echo "‚úÖ SonarQube Î∂ÑÏÑù ÏôÑÎ£å (ÌÜ†ÌÅ∞ ÏÇ¨Ïö©)"
                                    } else {
                                        echo "‚ö†Ô∏è SonarQube Î∂ÑÏÑù ÏôÑÎ£å (ÏùºÎ∂Ä Í≤ΩÍ≥† Î∞úÏÉù, Í≥ÑÏÜç ÏßÑÌñâ)"
                                    }
                                }
                            } catch (Exception e2) {
                                echo "‚ö†Ô∏è SonarQube Î∂ÑÏÑù Ïã§Ìå®, Í≥ÑÏÜç ÏßÑÌñâ: ${e2.getMessage()}"
                            }
                        }
                    } else {
                        echo "‚ö†Ô∏è SonarQube ÏÑúÎ≤ÑÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Î∂ÑÏÑùÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§."
                    }
                    echo "‚úÖ SonarQube Îã®Í≥Ñ ÏôÑÎ£å - TrivyÎ°ú ÏßÑÌñâ"
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    // Trivy DB ÏóÖÎç∞Ïù¥Ìä∏
                    echo "üîÑ Updating Trivy DB..."
                    sh "docker run --rm -v trivy_cache:/root/.cache aquasec/trivy:latest image --download-db-only || true"
                    
                    def serviceList = env.SERVICES.split(',')
                    def TRIVY_OPTIONS = "--exit-code 0 --severity HIGH,CRITICAL --timeout 5m --no-progress --skip-db-update --skip-files 'root/.npm/_cacache/*' --cache-dir /root/.cache/trivy"
                    
                    // ÏÜåÏä§ ÏΩîÎìú Ïä§Ï∫î (ÎπåÎìú Ï†Ñ)
                    def scanSteps = [:]
                    serviceList.each { service ->
                        scanSteps["Scan-${service}"] = {
                            echo "üõ°Ô∏è Scanning [${service}] source code..."
                            sh """
                                docker run --rm \\
                                    -v \$(pwd):/workspace \\
                                    -v trivy_cache:/root/.cache \\
                                    -w /workspace \\
                                    aquasec/trivy:latest fs ${TRIVY_OPTIONS} \\
                                    backend/${service}/ 2>&1 || true
                            """
                        }
                    }
                    
                    // Î≥ëÎ†¨ Ïä§Ï∫î Ïã§Ìñâ
                    parallel scanSteps
                    echo "‚úÖ Trivy Î≥¥Ïïà Ïä§Ï∫î ÏôÑÎ£å - ÎπåÎìúÎ°ú ÏßÑÌñâ"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                        withCredentials([usernamePassword(credentialsId: "${CREDENTIAL_ID}", usernameVariable: 'HUB_USER', passwordVariable: 'HUB_PASS')]) {
                        // Harbor Î°úÍ∑∏Ïù∏ (HTTP ÏÇ¨Ïö©)
                        // Ï£ºÏùò: Ìò∏Ïä§Ìä∏ ÎÖ∏ÎìúÏùò Docker daemonÏù¥ insecure registryÎ•º Ïù∏ÏãùÌïòÎ†§Î©¥ Ïû¨ÏãúÏûë ÌïÑÏöî
                        sh """
                            # Harbor Î°úÍ∑∏Ïù∏ (ÌîÑÎ°úÌÜ†ÏΩú ÏóÜÏù¥ ÏãúÎèÑ - Docker daemonÏù¥ insecure registryÎ°ú Ïù∏Ïãù)
                            echo "\${HUB_PASS}" | docker login 192.168.56.200:30002 -u \${HUB_USER} --password-stdin
                        """

                        def serviceList = env.SERVICES.split(',')
                        
                        // Î≥ëÎ†¨ ÎπåÎìú (Îπ†Î•∏ ÎπåÎìú)
                        def buildSteps = [:]
                        serviceList.each { service ->
                            buildSteps["Build-${service}"] = {
                                echo "üì¶ Building [${service}]..."
                                def imageBase = "192.168.56.200:30002/${HARBOR_PROJECT}/${service}"
                                timeout(time: 30, unit: 'MINUTES') {
                                    sh """
                                        # BuildKit ÌôúÏÑ±Ìôî Î∞è Ï∫êÏãú Ïù¥ÎØ∏ÏßÄ pull
                                        export DOCKER_BUILDKIT=1
                                        docker pull ${imageBase}:latest || true
                                        
                                        # BuildKitÏùÑ ÏÇ¨Ïö©Ìïú Îπ†Î•∏ ÎπåÎìú (ÌÉÄÏûÑÏïÑÏõÉ Î∞è ÏßÑÌñâ ÏÉÅÌô© ÌëúÏãú)
                                        docker build \\
                                            --build-arg APP_NAME=${service} \\
                                            --cache-from ${imageBase}:latest \\
                                            --progress=plain \\
                                            --no-cache=false \\
                                            -f backend/${service}/Dockerfile \\
                                            -t ${imageBase}:${env.FULL_VERSION} \\
                                            -t ${imageBase}:latest \\
                                            backend/ || {
                                            echo "‚ö†Ô∏è Build failed, retrying without cache..."
                                            docker build \\
                                                --build-arg APP_NAME=${service} \\
                                                --no-cache=false \\
                                                -f backend/${service}/Dockerfile \\
                                                -t ${imageBase}:${env.FULL_VERSION} \\
                                                -t ${imageBase}:latest \\
                                                backend/
                                        }
                                    """
                                }
                            }
                        }
                        
                        // Î≥ëÎ†¨ ÎπåÎìú Ïã§Ìñâ
                        parallel buildSteps
                        echo "‚úÖ All images built successfully"
                        
                        // Î≥ëÎ†¨ Ìë∏Ïãú (ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï)
                        def pushSteps = [:]
                        serviceList.each { service ->
                            pushSteps["Push-${service}"] = {
                                timeout(time: 10, unit: 'MINUTES') {
                                    echo "üì§ Pushing [${service}]..."
                                    retry(3) {
                                        sh """
                                            docker push 192.168.56.200:30002/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION} || {
                                                echo "‚ö†Ô∏è Push failed, retrying..."
                                                sleep 2
                                                docker push 192.168.56.200:30002/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION}
                                            }
                                            docker push 192.168.56.200:30002/${HARBOR_PROJECT}/${service}:latest || {
                                                echo "‚ö†Ô∏è Push latest failed, retrying..."
                                                sleep 2
                                                docker push 192.168.56.200:30002/${HARBOR_PROJECT}/${service}:latest
                                            }
                                            docker rmi 192.168.56.200:30002/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION} || true
                                        """
                                    }
                                }
                            }
                        }
                        
                        // Î≥ëÎ†¨ Ìë∏Ïãú Ïã§Ìñâ
                        parallel pushSteps
                        echo "‚úÖ All images pushed to Harbor"
                        
                        sh "docker logout 192.168.56.200:30002"
                    }
                }
            }
        }
    }

    post {
        success { echo "‚úÖ Î∞±ÏóîÎìú Î∞∞Ìè¨ Ï§ÄÎπÑ ÏôÑÎ£å! ÌïòÎ≤ÑÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî." }
        failure { echo "‚ùå ÎπåÎìú Ïã§Ìå®! Î°úÍ∑∏Î•º ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî." }
    }
}
