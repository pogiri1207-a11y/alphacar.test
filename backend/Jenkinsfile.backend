pipeline {
    agent any

    parameters {
        // ë¹Œë“œí•  ì„œë¹„ìŠ¤ë¥¼ ì„ íƒ (ì „ì²´ ë¹Œë“œë„ ê°€ëŠ¥í•˜ê²Œ 'all' ì¶”ê°€)
        choice(name: 'SERVICE_NAME', 
               choices: ['all', 'main', 'aichat', 'news', 'mypage', 'community', 'search', 'quote'], 
               description: 'ë¹Œë“œí•  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”')
        string(name: 'VERSION', defaultValue: '1.0', description: 'ê¸°ë³¸ ë²„ì „ (ë’¤ì— ë¹Œë“œ ë²ˆí˜¸ê°€ ìë™ìœ¼ë¡œ ë¶™ìŠµë‹ˆë‹¤)')
    }

    environment {
        HARBOR_URL = '192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        CREDENTIAL_ID = 'harbor-cred' // ì  í‚¨ìŠ¤ì— ë“±ë¡í•œ Harbor ID/PW
        SONARQUBE = 'sonarqube'
        SONAR_URL = 'http://192.168.56.200:32001'
        SONAR_TOKEN_ID = 'sonarqube-token' // SonarQube í† í° (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •)
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    // ë²„ì „ ë²ˆí˜¸ ìƒì„± (ì˜ˆ: 1.0.25)
                    env.FULL_VERSION = "${params.VERSION}.${currentBuild.number}"
                    
                    // ë¹Œë“œí•  ì„œë¹„ìŠ¤ ëª©ë¡ ê²°ì •
                    if (params.SERVICE_NAME == 'all') {
                        env.SERVICES = 'main,aichat,news,mypage,community,search,quote'
                    } else {
                        env.SERVICES = params.SERVICE_NAME
                    }
                    echo "ğŸš€ Target Services: ${env.SERVICES} / Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    // SonarQube ì—°ê²° í™•ì¸ ë° ì„ íƒì  ì‹¤í–‰
                    def sonarAvailable = false
                    try {
                        def response = sh(
                            script: "curl -s -m 5 ${SONAR_URL}/api/system/status || echo 'FAILED'",
                            returnStdout: true
                        ).trim()
                        if (response.contains('"status"') || response.contains('UP')) {
                            sonarAvailable = true
                            echo "âœ… SonarQube ì„œë²„ ì—°ê²° í™•ì¸ë¨"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                    
                    if (sonarAvailable) {
                        def scannerHome = tool 'sonar-scanner'
                        
                        // SonarQube ì¸ì¦ í† í° ì‚¬ìš©
                        try {
                            withSonarQubeEnv("${SONARQUBE}") {
                                sh """
                                    ${scannerHome}/bin/sonar-scanner \\
                                        -Dsonar.projectKey=alphacar-backend \\
                                        -Dsonar.projectName=alphacar-backend \\
                                        -Dsonar.sources=backend \\
                                        -Dsonar.host.url=${SONAR_URL} \\
                                        -Dsonar.sourceEncoding=UTF-8 \\
                                        -Dsonar.scanner.timeout=300
                                """
                            }
                            echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ"
                        } catch (Exception e) {
                            // withSonarQubeEnv ì‹¤íŒ¨ ì‹œ í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„
                            echo "âš ï¸ withSonarQubeEnv ì‹¤íŒ¨, í† í° ì§ì ‘ ì‚¬ìš© ì‹œë„..."
                            try {
                                withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'SONAR_TOKEN')]) {
                                    sh """
                                        ${scannerHome}/bin/sonar-scanner \\
                                            -Dsonar.projectKey=alphacar-backend \\
                                            -Dsonar.projectName=alphacar-backend \\
                                            -Dsonar.sources=backend \\
                                            -Dsonar.host.url=${SONAR_URL} \\
                                            -Dsonar.token=\${SONAR_TOKEN} \\
                                            -Dsonar.sourceEncoding=UTF-8 \\
                                            -Dsonar.scanner.timeout=300
                                    """
                                }
                                echo "âœ… SonarQube ë¶„ì„ ì™„ë£Œ (í† í° ì‚¬ìš©)"
                            } catch (Exception e2) {
                                echo "âš ï¸ SonarQube ë¶„ì„ ì‹¤íŒ¨, ê³„ì† ì§„í–‰: ${e2.getMessage()}"
                            }
                        }
                    } else {
                        echo "âš ï¸ SonarQube ì„œë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                    echo "âœ… SonarQube ë‹¨ê³„ ì™„ë£Œ - Trivyë¡œ ì§„í–‰"
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    // Trivy DB ì—…ë°ì´íŠ¸
                    echo "ğŸ”„ Updating Trivy DB..."
                    sh "docker run --rm -v trivy_cache:/root/.cache aquasec/trivy:latest image --download-db-only || true"
                    
                    def serviceList = env.SERVICES.split(',')
                    def TRIVY_OPTIONS = "--exit-code 0 --severity HIGH,CRITICAL --timeout 5m --no-progress --skip-db-update --skip-files 'root/.npm/_cacache/*' --cache-dir /root/.cache/trivy"
                    
                    // ì†ŒìŠ¤ ì½”ë“œ ìŠ¤ìº” (ë¹Œë“œ ì „)
                    def scanSteps = [:]
                    serviceList.each { service ->
                        scanSteps["Scan-${service}"] = {
                            echo "ğŸ›¡ï¸ Scanning [${service}] source code..."
                            sh """
                                docker run --rm \\
                                    -v \$(pwd):/workspace \\
                                    -v trivy_cache:/root/.cache \\
                                    -w /workspace \\
                                    aquasec/trivy:latest fs ${TRIVY_OPTIONS} \\
                                    backend/${service}/ 2>&1 || true
                            """
                        }
                    }
                    
                    // ë³‘ë ¬ ìŠ¤ìº” ì‹¤í–‰
                    parallel scanSteps
                    echo "âœ… Trivy ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ - ë¹Œë“œë¡œ ì§„í–‰"
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: "${CREDENTIAL_ID}", usernameVariable: 'HUB_USER', passwordVariable: 'HUB_PASS')]) {
                        // Harbor ë¡œê·¸ì¸
                        sh "echo ${HUB_PASS} | docker login ${HARBOR_URL} -u ${HUB_USER} --password-stdin"

                        def serviceList = env.SERVICES.split(',')
                        
                        // ë³‘ë ¬ ë¹Œë“œ (ë¹ ë¥¸ ë¹Œë“œ)
                        def buildSteps = [:]
                        serviceList.each { service ->
                            buildSteps["Build-${service}"] = {
                                echo "ğŸ“¦ Building [${service}]..."
                                sh """
                                    # ìºì‹œ ì´ë¯¸ì§€ pull ì‹œë„
                                    docker pull ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:latest || true
                                    
                                    # ë¹Œë“œ (ìºì‹œ ì‚¬ìš©)
                                    docker build \\
                                        --build-arg APP_NAME=${service} \\
                                        --cache-from ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:latest \\
                                        -f backend/${service}/Dockerfile \\
                                        -t ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION} \\
                                        -t ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:latest \\
                                        backend/
                                """
                            }
                        }
                        
                        // ë³‘ë ¬ ë¹Œë“œ ì‹¤í–‰
                        parallel buildSteps
                        echo "âœ… All images built successfully"
                        
                        // ë³‘ë ¬ í‘¸ì‹œ
                        def pushSteps = [:]
                        serviceList.each { service ->
                            pushSteps["Push-${service}"] = {
                                echo "ğŸ“¤ Pushing [${service}]..."
                                sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION}"
                                sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:latest"
                                sh "docker rmi ${HARBOR_URL}/${HARBOR_PROJECT}/${service}:${env.FULL_VERSION} || true"
                            }
                        }
                        
                        // ë³‘ë ¬ í‘¸ì‹œ ì‹¤í–‰
                        parallel pushSteps
                        echo "âœ… All images pushed to Harbor"
                        
                        sh "docker logout ${HARBOR_URL}"
                    }
                }
            }
        }
    }

    post {
        success { echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ! í•˜ë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”." }
        failure { echo "âŒ ë¹Œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”." }
    }
}
