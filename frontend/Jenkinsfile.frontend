pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        IMAGE_NAME = 'frontend'
        CREDENTIAL_ID = 'harbor-cred'
        SONAR_TOKEN_ID = 'sonarqube-token'
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    def baseVer = "1.0"
                    try {
                        baseVer = readFile('frontend/version.txt').trim()
                    } catch (e) {
                        echo "âš ï¸ version.txt ì—†ìŒ, 1.0 ì‚¬ìš©"
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'S_TOKEN')]) {
                        // ğŸš€ ì†Œë‚˜íë¸Œ ì œì™¸ ì˜µì…˜ìœ¼ë¡œ ì†ë„ ëŒ€í­ í–¥ìƒ
                        sh """
                        ${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=alphacar-frontend \
                        -Dsonar.sources=frontend \
                        -Dsonar.host.url=http://192.168.56.200:32001 \
                        -Dsonar.login=${S_TOKEN} \
                        -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/out/**
                        """
                    }
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // 1. ë„ì»¤ íˆ´ ì„¤ì¹˜ ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    def dockerHome = tool name: 'docker'
                    
                    // 2. ë„ì»¤ ê²½ë¡œë¥¼ ì‹œìŠ¤í…œ PATH ë§¨ ì•ì— ê°•ì œë¡œ ë¼ì›Œë„£ìŠµë‹ˆë‹¤. (í•µì‹¬ í•´ê²°ì±…)
                    withEnv(["PATH=${dockerHome}/bin:${env.PATH}"]) {
                        echo "ğŸ”¨ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘: ${env.FULL_VERSION}"
                        
                        // ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
                        def imageTag = "${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                        
                        // ë¹Œë“œ ì‹¤í–‰
                        sh "docker build -f frontend/Dockerfile -t ${imageTag} frontend/"
                        
                        // í•˜ë²„ í‘¸ì‹œ (PATHê°€ ì„¤ì •ë˜ì–´ ìˆì–´ í”ŒëŸ¬ê·¸ì¸ì´ ë„ì»¤ë¥¼ ì˜ ì°¾ìŠµë‹ˆë‹¤)
                        docker.withRegistry("http://${HARBOR_URL}", "${CREDENTIAL_ID}") {
                            sh "docker push ${imageTag}"
                        }
                        
                        // ë¡œì»¬ ì´ë¯¸ì§€ ì •ë¦¬
                        sh "docker rmi ${imageTag}"
                    }
                }
            }
        }
    }

    post {
        success { echo "âœ… ëª¨ë“  ë‹¨ê³„ ì„±ê³µ!" }
        failure { echo "âŒ ë¹Œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." }
    }
}
