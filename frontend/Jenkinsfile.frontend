pipeline {
    agent any

    environment {
        // Harbor
        HARBOR_URL     = '192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        IMAGE_NAME     = 'frontend'
        HARBOR_CRED_ID = 'harbor-cred'

        // SonarQube
        SONAR_HOST_URL = 'http://192.168.56.200:32001'
        SONAR_TOKEN_ID = 'sonarqube-token'
    }

    stages {

        stage('Prepare') {
            steps {
                script {
                    def baseVer = "1.0"
                    try {
                        baseVer = readFile('frontend/version.txt').trim()
                    } catch (e) {
                        echo "‚ö†Ô∏è version.txt ÏóÜÏùå ‚Üí 1.0 ÏÇ¨Ïö©"
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}"
                    echo "üì¶ Build Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    withCredentials([string(credentialsId: SONAR_TOKEN_ID, variable: 'S_TOKEN')]) {
                        sh """
                        ${scannerHome}/bin/sonar-scanner \
                          -Dsonar.projectKey=alphacar-frontend \
                          -Dsonar.sources=frontend \
                          -Dsonar.host.url=${SONAR_HOST_URL} \
                          -Dsonar.login=${S_TOKEN} \
                          -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/out/**
                        """
                    }
                }
            }
        }

        // ‚≠ê ÌïµÏã¨: ÌíàÏßà Í∏∞Ï§Ä Ïã§Ìå® Ïãú Ïó¨Í∏∞ÏÑú Î∞îÎ°ú Ï¢ÖÎ£å
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    def imageTag = "${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"

                    echo "üê≥ Docker Build: ${imageTag}"
                    sh "docker build -f frontend/Dockerfile -t ${imageTag} frontend/"

                    withCredentials([usernamePassword(
                        credentialsId: HARBOR_CRED_ID,
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                    )]) {
                        sh """
                        docker login ${HARBOR_URL} -u ${HARBOR_USER} -p ${HARBOR_PASS}
                        docker push ${imageTag}
                        docker logout ${HARBOR_URL}
                        """
                    }

                    sh "docker rmi ${imageTag} || true"
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ SonarQube ÌÜµÍ≥º + Harbor Push ÏÑ±Í≥µ"
        }
        failure {
            echo "‚ùå ÌíàÏßà Í∏∞Ï§Ä Ïã§Ìå® ÎòêÎäî ÎπåÎìú Ïò§Î•ò"
        }
    }
}

